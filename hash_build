build_arch = "64"
if eq(get_platform(), windows) {
    target_exec = "electron.exe"
    dylib_prefix = ".dll"
    dylib_id = ""
    object_add_link_options(mwindows)
} else {
    target_exec = "electron"
    dylib_prefix = ".so"
    dylib_id = "lib"
}

load_module("scripts/electron_build_utils.py")
gles_path = ":libGLESv2.so.angle"
egl_path = ":libEGL.so.angle"

std_cxx = "20"

object_add_link_options(m64)

impl_target_file = null

object_add_compile_options(fPIC)
object_add_compile_options(g) # include debug symbols
object_add_compile_options(Werror)
object_add_compile_options("Wno-unused")
object_add_compile_options("I /usr/include/")

dump_compilation_commands(0)

target_impls = [
    project_configuration_impl,
    render_preview_impl,
    layer_properties_impl,
    asset_manager_impl,
    dockspace_impl,
    async_writer,
    audio_server
]

target_layers = [
    sdf2d_layer
]

scenario build_imgui {
    info("Building ImGui shared library")

    imgui_targets = glob_files("src/ImGui/", "cpp")
    imgui_targets = cat($imgui_targets, ["src/ImGuiFileDialog.cpp"])
    imgui_objects = object_compile(
        $imgui_targets,
        $build_arch
    )
    link_executable($imgui_objects, cat($dylib_id, cat("imgui", $dylib_prefix)), [], shared)
}

scenario build_core {
    info("starting Electron build")
    object_add_compile_definition("GLEW_STATIC")
    compilation_targets = cat(glob_files("src", "cpp"), glob_files("src", "c"))
    compilation_targets = filter_list_from_string($compilation_targets, "imgui")
    compilation_targets = filter_list_from_string($compilation_targets, "ImGui")
    compilation_targets = filter_list_from_string($compilation_targets, "implot")
    compilation_targets = filter_list_from_string($compilation_targets, "electron.cpp")
    objects = object_compile(
        $compilation_targets,
        $build_arch
    )

    deps = list()
    if eq(get_platform(), windows) {
        deps = [
            opengl32, glfw3, windowscodecs, ole32, shlwapi, pthread, dbgeng, backtrace, dbgeng, bfd, dbghelp, curl
        ]
    } else {
        deps = [
            glfw, m, pthread, "stdc++", dl, backtrace, bfd, xcb, curl, GLESv2, EGL
        ]
    }

    if eq(get_platform(), windows) {
        object_add_link_options(static)
        object_add_link_options("static-libstdc++")
    } else {
        object_add_link_options("rdynamic")
    }
    link_executable($objects, cat($dylib_id, cat($target_exec, $dylib_prefix)), $deps, shared)
}

scenario build_starter {
    starter_targets = ["src/electron.cpp"]
    starter_objects = object_compile($starter_targets, $build_arch)
    link_executable($starter_objects, "electron", 
        [electron, imgui]
    )
}

scenario build_impl {
    info(cat("compiling impl ", $impl_target_file))

    shared_library_name = cat($dylib_id, cat($impl_target_file, $dylib_prefix))
    object_set_include_path("src/")
    impl_objects = object_compile(cat(cat("impl/", $impl_target_file), ".cpp"), $build_arch)

    impl_deps = list()
    if eq(get_platform(), windows) {
        impl_deps = [
            opengl32, glfw3, pthread, dbgeng, backtrace, bfd, dbghelp, imgui, electron
        ]
    } else {
        impl_deps = [
            "stdc++", dl, pthread, backtrace, bfd, dl
        ]
    }
    if eq($impl_target_file, audio_server) {
        impl_deps = cat($impl_deps, [soloud, SDL2])
    }
    link_executable($impl_objects, $shared_library_name, $impl_deps, shared)
}

scenario build_layer {
    call_scenario(build_impl)
    mv(cat($dylib_id, cat($impl_target_file, $dylib_prefix)), cat("layers/", cat($dylib_id, cat($impl_target_file, $dylib_prefix))))
}

scenario clean {
    if path_exists($target_exec) {
        rm($target_exec) 
    }
    if path_exists("layers/") {
        rmtree("layers")
    }

    mkdir("layers")
    object_clean()

    for_each($target_impls, shared_lib_name, clean_shared_library)
}

scenario clean_shared_library {
    rm_path = cat($shared_lib_name, $dylib_prefix)
    if path_exists($rm_path) {
        rm($rm_path)
    }
}

scenario build {
    if path_exists($target_exec) {
        rm($target_exec)
    }
    call_scenario(build_imgui)
    call_scenario(build_core)
    call_scenario(build_starter)

    if not(path_exists("layers/")) {
        mkdir("layers")
    }

    object_add_compile_definition(ELECTRON_IMPLEMENTATION_MODE)
    for_each($target_impls, impl_target_file, execute_build_impl)
    for_each($target_layers, impl_target_file, execute_build_layer)
}

scenario execute_build_impl {
    call_scenario(build_impl)
}

scenario execute_build_layer {
    call_scenario(build_layer)
}


default_scenario = build